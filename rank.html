<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ranking de Empresas ‚Ä¢ CQ</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    .trophy {
      font-size: 28px;
      margin-right: 8px;
    }
    .gold { color: #ffdd00; }
    .silver { color: #c0c0c0; }
    .bronze { color: #cd7f32; }
  </style>
</head>

<body data-guard="true">

<div class="app">

  <!-- NAVBAR -->
  <div class="navbar card">
    <div class="brand">
      <div class="logo">CQ</div>
      <div>
        <div style="font-weight:800;">Ranking de Empresas</div>
        <div class="small user-email"></div>
      </div>
    </div>

    <div class="nav-actions">
      <button class="btn ghost" onclick="location.href='home.html'">Voltar</button>
    </div>
  </div>

  <div class="grid">

    <!-- SIDEBAR -->
    <div class="sidebar card">
      <h4 class="small">Ranking</h4>
      <p class="small">TOP 10 melhores empresas</p>
    </div>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="card">
      <h1 class="h1">Melhores Empresas</h1>
      <p class="small">Baseado na menor quantidade de den√∫ncias registradas</p>

      <div id="rank-list" style="margin-top:18px;">
        Carregando...
      </div>
    </div>

  </div>

  <div class="footer">Control Quality ‚Ä¢ Ranking</div>

</div>

<!-- SCRIPTS -->
<script src="firebase.js"></script>
<script src="auth.js"></script>
<script src="auth-guard.js"></script>
<script>
async function loadRank() {
  const out = document.getElementById("rank-list");

  try {
    // 1. BUSCAR TODAS AS EMPRESAS
    const companiesSnap = await db.collection("users")
      .where("type", "==", "company")
      .get();

    if (companiesSnap.empty) {
      out.innerHTML = "<p class='small'>Nenhuma empresa cadastrada.</p>";
      return;
    }

    let list = [];

    // 2. PARA CADA EMPRESA, CONTAR AS DEN√öNCIAS
    for (let doc of companiesSnap.docs) {
      const company = doc.data();
      const companyName = company.companyName;

      // den√∫ncias dessa empresa
      const repSnap = await db.collection("reports")
        .where("companyName", "==", companyName)
        .where("category", "==", "SERVICE_QUALITY")
        .get();

      list.push({
        id: doc.id,
        companyName,
        email: company.email,
        totalReports: repSnap.size
      });
    }

    // 3. ORDENAR POR MENOR N√öMERO DE DEN√öNCIAS
    list.sort((a, b) => a.totalReports - b.totalReports);

    // 4. PEGAR APENAS TOP 10
    list = list.slice(0, 10);

    // 5. GERAR HTML
    let html = "";

    list.forEach((c, index) => {
      let trophy = "";

      if (index === 0) trophy = `<span class="trophy gold">üèÜ</span>`;
      else if (index === 1) trophy = `<span class="trophy silver">ü•à</span>`;
      else if (index === 2) trophy = `<span class="trophy bronze">ü•â</span>`;
      else trophy = `<span class="trophy">‚≠ê</span>`;

      html += `
        <div class="list-item">
          <div style="display:flex;align-items:center;">
            ${trophy}
            <strong>${index + 1}. ${c.companyName}</strong>
          </div>

          <div>
            <span class="badge ${c.totalReports === 0 ? 'open' : 'closed'}">
              ${c.totalReports} den√∫ncias
            </span>
            <div style="margin-top:8px;">
              <button class="btn ghost"
                onclick="location.href='rank-detail.html?id=${c.id}'">
                Ver detalhes
              </button>
            </div>
          </div>
        </div>
      `;
    });

    out.innerHTML = html;

  } catch (err) {
    console.error(err);
    out.innerHTML = "<p class='small'>Erro ao carregar ranking.</p>";
  }
}

loadRank();
</script>

</body>
</html>
