<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Criar DenÃºncia</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body data-guard="true">
<div class="app">

  <div class="navbar card">
    <div class="brand">
      <div class="logo">CQ</div>
      <div>
        <div style="font-weight:800;">Criar DenÃºncia</div>
        <div class="small user-email"></div>
      </div>
    </div>
    <div class="nav-actions">
      <button class="btn ghost" onclick="location.href='home.html'">Voltar</button>
    </div>
  </div>

  <div class="grid">

    <!-- MENU LATERAL -->
    <div class="sidebar card">
      <ul class="nav-list">
        <li><a href="home.html">ğŸ  Menu principal</a></li>

        <span id="menu-user">
          <li><a href="complaint-create.html">â• Criar reclamaÃ§Ã£o</a></li>
          <li><a href="complaint-list.html">ğŸ“‹ Minhas reclamaÃ§Ãµes</a></li>
          <li><a class="active" href="report-create.html">âš  Criar denÃºncia</a></li>
          <li><a href="report-list.html">ğŸ” Minhas denÃºncias</a></li>
        </span>

        <span id="menu-company">
          <li><a href="company-panel.html">ğŸ¢ Painel da empresa</a></li>
          <li><a href="company-dashboard.html">ğŸ“Š Dashboard</a></li>
          <li><a href="company-reports.html">ğŸš¨ DenÃºncias recebidas</a></li>
          <li><a href="company-profile.html">ğŸ‘¤ Perfil da empresa</a></li>
        </span>
      </ul>
    </div>

    <!-- CONTEÃšDO PRINCIPAL -->
    <div class="card" style="max-width:720px;margin:auto">
      <h1 class="h1">Nova DenÃºncia (Qualidade de ServiÃ§o)</h1>

      <div class="field">
        <label class="small">Empresa alvo</label>
        <!-- se for preenchido via URL, mostramos em read-only -->
        <input id="companyName" type="text" placeholder="Nome exato da empresa (ex: ifood)">
      </div>

      <div class="field">
        <label class="small">Motivo</label>
        <input id="reason" type="text" placeholder="Ex: Atraso constante nas entregas">
      </div>

      <div class="field">
        <label class="small">DescriÃ§Ã£o</label>
        <textarea id="description" placeholder="Descreva detalhadamente a queixa relacionada Ã  qualidade do serviÃ§o"></textarea>
      </div>

      <div style="display:flex;gap:12px;margin-top:16px;">
        <button class="btn" id="send-report">Enviar DenÃºncia</button>
        <button class="btn ghost" onclick="location.href='home.html'">Cancelar</button>
      </div>

      <div id="hint" class="small" style="margin-top:12px;color:rgba(255,255,255,0.7)"></div>
    </div>

  </div>

</div>

<script src="firebase.js"></script>
<script src="auth.js"></script>
<script src="auth-guard.js"></script>
<script src="app.js"></script>

<script>
(async function(){
  // Preenche company se vier da URL: ?company=Nome%20da%20Empresa
  const params = new URLSearchParams(location.search);
  const preCompany = params.get('company');
  if (preCompany) {
    const input = document.getElementById('companyName');
    input.value = decodeURIComponent(preCompany);
    // deixar read-only para evitar troca
    input.readOnly = true;
    document.getElementById('hint').textContent = "Empresa preenchida automaticamente. Confirme e envie.";
  }

  // Menu inteligente
  auth.onAuthStateChanged(async user=>{
    if(!user) return;
    const snap = await db.collection('users').doc(user.uid).get();
    if(!snap.exists) return;
    const data = snap.data();
    const menuUser = document.getElementById('menu-user');
    const menuCompany = document.getElementById('menu-company');
    if(data.type === 'company'){
      menuCompany.style.display = 'block';
      menuUser.style.display = 'none';
    } else {
      menuCompany.style.display = 'none';
      menuUser.style.display = 'block';
    }
  });

  document.getElementById('send-report').addEventListener('click', async ()=> {
    const companyName = (document.getElementById('companyName').value || '').trim();
    const reason = (document.getElementById('reason').value || '').trim();
    const description = (document.getElementById('description').value || '').trim();

    if(!companyName || !reason || !description){
      alert('Preencha todos os campos!');
      return;
    }

    // Verificar se existe empresa com esse companyName
    const q = await db.collection('users')
      .where('companyName', '==', companyName)
      .where('type', '==', 'company')
      .limit(1)
      .get();

    if(q.empty){
      alert('Empresa nÃ£o encontrada. Verifique o nome exato da empresa.');
      return;
    }

    try {
      await db.collection('reports').add({
        userId: auth.currentUser.uid,
        companyName,
        category: 'SERVICE_QUALITY',
        reason,
        description,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert('DenÃºncia registrada com sucesso!');
      location.href = 'report-list.html';
    } catch (err) {
      console.error(err);
      alert('Erro ao enviar denÃºncia: ' + err.message);
    }
  });
})();
</script>

</body>
</html>
