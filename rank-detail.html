<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Empresa • Ranking</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body data-guard="true">

<div class="app">

  <!-- NAVBAR -->
  <div class="navbar card">
    <div class="brand">
      <div class="logo">CQ</div>
      <div>
        <div style="font-weight:800;">Detalhes da Empresa</div>
        <div class="small user-email"></div>
      </div>
    </div>

    <div class="nav-actions">
      <button class="btn ghost" onclick="history.back()">Voltar</button>
    </div>
  </div>

  <div class="grid">

    <!-- SIDEBAR -->
    <div class="sidebar card">
      <h4 class="small">Ranking</h4>
      <p class="small">Informações completas da empresa</p>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="card">
      <h1 class="h1">Informações da Empresa</h1>

      <div id="rank-company-box" style="margin-top:16px;">
        Carregando detalhes...
      </div>

      <hr style="margin:25px 0; border-color:rgba(255,255,255,0.06);">

      <h2 class="h1" style="font-size:22px;">Denúncias Registradas</h2>
      <div id="rank-report-list" style="margin-top:14px;">
        Carregando denúncias...
      </div>

    </div>

  </div>

  <div class="footer">Control Quality • Ranking</div>

</div>

<!-- SCRIPTS -->
<script src="firebase.js"></script>
<script src="auth.js"></script>
<script src="auth-guard.js"></script>

<script>
const params = new URLSearchParams(location.search);
const companyId = params.get("id");

async function loadRankDetail() {
  const output = document.getElementById("rank-company-box");
  const reportList = document.getElementById("rank-report-list");

  if (!companyId) {
    output.innerHTML = "<p class='small'>ID inválido.</p>";
    return;
  }

  try {
    // 1. BUSCAR EMPRESA
    const doc = await db.collection("users").doc(companyId).get();

    if (!doc.exists) {
      output.innerHTML = "<p class='small'>Empresa não encontrada.</p>";
      return;
    }

    const data = doc.data();
    const companyName = data.companyName;

    output.innerHTML = `
      <div class="card">
        <p><b>Nome da empresa:</b> ${companyName}</p>
        <p><b>Email:</b> ${data.email}</p>
        <p><b>ID:</b> ${companyId}</p>
      </div>
    `;

    // 2. BUSCAR DENÚNCIAS
    const snap = await db.collection("reports")
      .where("companyName", "==", companyName)
      .where("category", "==", "SERVICE_QUALITY")
      .orderBy("createdAt", "desc")
      .get();

    if (snap.empty) {
      reportList.innerHTML = "<p class='small'>Nenhuma denúncia registrada.</p>";
      return;
    }

    let html = "";

    snap.forEach(d => {
      const rep = d.data();
      const dt = rep.createdAt
        ? new Date(rep.createdAt.seconds * 1000).toLocaleString()
        : "—";

      html += `
        <div class="list-item">
          <div>
            <strong>${rep.reason}</strong>
            <div class="small">${dt}</div>
            <p class="small">${rep.description}</p>
          </div>
        </div>
      `;
    });

    reportList.innerHTML = html;

  } catch (err) {
    console.error(err);
    output.innerHTML = "<p class='small'>Erro ao carregar dados.</p>";
  }
}

loadRankDetail();
</script>

</body>
</html>
