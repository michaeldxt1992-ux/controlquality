<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Detalhes da ReclamaÃ§Ã£o</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body data-guard="true">

  <div class="app">

    <!-- NAVBAR -->
    <div class="navbar card">
      <div class="brand">
        <div class="logo">CQ</div>
        <div>
          <div style="font-weight:800;">Detalhes</div>
          <div class="small user-email"></div>
        </div>
      </div>

      <div class="nav-actions">
        <button class="btn ghost" onclick="location.href='complaint-list.html'">
          Voltar
        </button>
      </div>
    </div>

    <div class="grid">

      <!-- MENU LATERAL -->
      <div class="sidebar card">
        <ul class="nav-list">

          <li><a href="home.html">ğŸ  Menu principal</a></li>

          <!-- MENU DO USUÃRIO -->
          <span id="menu-user">
            <li><a href="complaint-create.html">â• Criar reclamaÃ§Ã£o</a></li>
            <li><a href="complaint-list.html">ğŸ“‹ Minhas reclamaÃ§Ãµes</a></li>

            <!-- DENÃšNCIAS -->
            <li><a href="report-create.html">âš  Criar denÃºncia</a></li>
            <li><a href="report-list.html">ğŸ” Minhas denÃºncias</a></li>
          </span>

          <!-- MENU DA EMPRESA -->
          <span id="menu-company">
            <li><a href="company-panel.html">ğŸ¢ Painel da empresa</a></li>
            <li><a href="company-dashboard.html">ğŸ“Š Dashboard</a></li>
            <li><a href="company-reports.html">ğŸš¨ DenÃºncias recebidas</a></li>
            <li><a href="company-profile.html">ğŸ‘¤ Perfil da empresa</a></li>
          </span>

        </ul>
      </div>

      <!-- CONTEÃšDO PRINCIPAL -->
      <div class="card" style="max-width:760px; margin:auto">

        <h1 class="h1">ReclamaÃ§Ã£o</h1>

        <div id="detail" class="small" style="margin-top:12px;">
          Carregando...
        </div>

        <!-- BOTÃƒO DE DENÃšNCIA -->
        <div style="margin-top:22px;">
          <button id="btn-report" class="btn ghost" style="display:none;">
            âš  Denunciar esta empresa
          </button>
        </div>

      </div>

    </div>

    <div class="footer">Control Quality â€¢ Dark Neon UI</div>

  </div>

  <!-- SCRIPTS -->
  <script src="firebase.js"></script>
  <script src="auth.js"></script>
  <script src="auth-guard.js"></script>
  <script src="app.js"></script>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    let companyNameGlobal = "";

    async function loadDetail() {
      if (!id) {
        document.getElementById("detail").innerHTML = "ID invÃ¡lido.";
        return;
      }

      const doc = await db.collection("complaints").doc(id).get();
      if (!doc.exists) {
        document.getElementById("detail").innerHTML = "ReclamaÃ§Ã£o nÃ£o encontrada.";
        return;
      }

      const data = doc.data();
      companyNameGlobal = data.company;

      const dt = data.createdAt
        ? new Date(data.createdAt.seconds * 1000).toLocaleString()
        : "â€”";

      document.getElementById("detail").innerHTML = `
        <strong>${data.title}</strong><br><br>

        <div class="small"><b>Empresa:</b> ${data.company}</div>
        <div class="small"><b>Status:</b> 
          <span class="badge ${data.status === 'open' ? 'open' : 'closed'}">
            ${data.status === 'open' ? 'Aberta' : 'Fechada'}
          </span>
        </div>
        <div class="small"><b>Criado em:</b> ${dt}</div>

        <hr style="border-color:rgba(255,255,255,0.08); margin:18px 0;">

        <div class="small"><b>DescriÃ§Ã£o:</b></div>
        <p>${data.description}</p>

        <hr style="border-color:rgba(255,255,255,0.08); margin:18px 0;">

        <div class="small"><b>Resposta da empresa:</b></div>
        <p>${data.response ? data.response : '<i>(Ainda sem resposta)</i>'}</p>
      `;

      // ATIVAR BOTÃƒO DE DENÃšNCIA
      document.getElementById("btn-report").style.display = "block";
    }

    loadDetail();

    // BOTÃƒO DENUNCIAR EMPRESA
    document.getElementById("btn-report").addEventListener("click", () => {
      location.href = "report-create.html?company=" + encodeURIComponent(companyNameGlobal);
    });

    // MENU INTELIGENTE
    auth.onAuthStateChanged(async user => {
      if (!user) return;
      const snap = await db.collection("users").doc(user.uid).get();
      if (!snap.exists) return;

      const data = snap.data();
      const type = data.type;

      const menuUser = document.getElementById("menu-user");
      const menuCompany = document.getElementById("menu-company");

      if (type === "company") {
        menuCompany.style.display = "block";
        menuUser.style.display = "none";
      } else {
        menuCompany.style.display = "none";
        menuUser.style.display = "block";
      }
    });
  </script>

</body>
</html>
